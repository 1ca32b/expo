{"version":3,"file":"index.js","names":["_ctxShared","data","require","_nodeFs","_interopRequireDefault","_nodePath","_generate","_matchers","_requireContextPonyfill","obj","__esModule","default","defaultCtx","requireContext","process","env","EXPO_ROUTER_APP_ROOT","EXPO_ROUTER_CTX_IGNORE","getWatchHandler","outputDir","ctx","regenerateFn","regenerateDeclarations","routeFiles","Set","keys","filter","key","isTypedRoute","callback","filePath","type","shouldRegenerate","relativePath","path","relative","isInsideAppRoot","startsWith","basename","__delete","has","delete","__add","add","exports","throttle","file","getTypedRoutesDeclarationFile","fs","writeFileSync","resolve","fn","interval","timerId","shouldRunAgain","run","args","setTimeout"],"sources":["../../../src/typed-routes/index.ts"],"sourcesContent":["import { EXPO_ROUTER_CTX_IGNORE } from 'expo-router/_ctx-shared';\nimport fs from 'node:fs';\nimport path from 'node:path';\n\nimport { getTypedRoutesDeclarationFile } from './generate';\nimport { isTypedRoute } from '../matchers';\nimport requireContext, {\n  RequireContextPonyFill,\n} from '../testing-library/require-context-ponyfill';\n\nconst defaultCtx = requireContext(process.env.EXPO_ROUTER_APP_ROOT, true, EXPO_ROUTER_CTX_IGNORE);\n\nexport type { RequireContextPonyFill } from '../testing-library/require-context-ponyfill';\n\n/**\n * Generate a Metro watch handler that regenerates the typed routes declaration file\n */\nexport function getWatchHandler(\n  outputDir: string,\n  { ctx = defaultCtx, regenerateFn = regenerateDeclarations } = {} // Exposed for testing\n) {\n  const routeFiles = new Set(ctx.keys().filter((key) => isTypedRoute(key)));\n\n  return async function callback({ filePath, type }: { filePath: string; type: string }) {\n    // Sanity check that we are in an Expo Router project\n    if (!process.env.EXPO_ROUTER_APP_ROOT) return;\n\n    let shouldRegenerate = false;\n    let relativePath = path.relative(process.env.EXPO_ROUTER_APP_ROOT, filePath);\n    const isInsideAppRoot = !relativePath.startsWith('../');\n    const basename = path.basename(relativePath);\n\n    if (!isInsideAppRoot) return;\n\n    // require.context paths always start with './' when relative to the root\n    relativePath = `./${relativePath}`;\n\n    if (type === 'delete') {\n      ctx.__delete(relativePath);\n      if (routeFiles.has(relativePath)) {\n        routeFiles.delete(relativePath);\n        shouldRegenerate = true;\n      }\n    } else if (type === 'add') {\n      ctx.__add(relativePath);\n      if (isTypedRoute(basename)) {\n        routeFiles.add(relativePath);\n        shouldRegenerate = true;\n      }\n    } else {\n      shouldRegenerate = routeFiles.has(relativePath);\n    }\n\n    if (shouldRegenerate) {\n      regenerateFn(outputDir, ctx);\n    }\n  };\n}\n\n/**\n * A throttled function that regenerates the typed routes declaration file\n */\nexport const regenerateDeclarations = throttle(\n  (outputDir: string, ctx: RequireContextPonyFill = defaultCtx) => {\n    const file = getTypedRoutesDeclarationFile(ctx);\n    if (!file) return;\n    fs.writeFileSync(path.resolve(outputDir, './router.d.ts'), file);\n  },\n  100\n);\n\n/**\n * Throttles a function to only run once every `internal` milliseconds.\n * If called while waiting, it will run again after the timer has elapsed.\n */\nfunction throttle<T extends (...args: any[]) => any>(fn: T, interval: number) {\n  let timerId;\n  let shouldRunAgain = false;\n  return function run(...args: Parameters<T>) {\n    if (timerId) {\n      shouldRunAgain = true;\n    } else {\n      fn(...args);\n      timerId = setTimeout(() => {\n        timerId = null; // reset the timer so next call will be executed\n        if (shouldRunAgain) {\n          shouldRunAgain = false;\n          run(...args); // call the function again\n        }\n      }, interval);\n    }\n  };\n}\n"],"mappings":"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"}