{"version":3,"file":"renderStaticContent.js","names":["require","_native","data","Font","_interopRequireWildcard","_react","_interopRequireDefault","_server2","_AppRegistry","_getRootComponent","_ctx","_ExpoRoot","_getReactNavigationConfig","_getRoutes","_getServerManifest","_head","_loadStaticParamsAsync","obj","__esModule","default","_getRequireWildcardCache","e","WeakMap","r","t","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","debug","AppRegistry","registerComponent","ExpoRoot","getManifest","options","routeTree","getRoutes","ctx","preserveApiRoutes","platform","Error","loadStaticParamsAsync","getReactNavigationConfig","getBuildTimeServerManifestAsync","getServerManifest","resetReactNavigationContexts","contexts","global","Map","getStaticContent","location","headContext","ref","React","createRef","element","getStyleElement","getApplication","initialProps","context","wrapper","children","createElement","Root","id","getRootComponent","resetServerContext","html","ReactDOMServer","renderToString","Head","Provider","ServerContainer","css","renderToStaticMarkup","output","mixHeadComponentsWithStaticResults","helmet","replace","fonts","getServerResources","length","join","key","reverse","result","toString","htmlAttributes","bodyAttributes"],"sources":["../../../src/static/renderStaticContent.tsx"],"sourcesContent":["/**\n * Copyright Â© 2023 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport '@expo/metro-runtime';\n\nimport { ServerContainer, ServerContainerRef } from '@react-navigation/native';\nimport * as Font from 'expo-font/build/server';\nimport React from 'react';\nimport ReactDOMServer from 'react-dom/server.node';\nimport { AppRegistry } from 'react-native-web';\n\nimport { getRootComponent } from './getRootComponent';\nimport { ctx } from '../../_ctx';\nimport { ExpoRoot } from '../ExpoRoot';\nimport { getReactNavigationConfig } from '../getReactNavigationConfig';\nimport { getRoutes, Options } from '../getRoutes';\nimport { ExpoRouterServerManifestV1, getServerManifest } from '../getServerManifest';\nimport { Head } from '../head';\nimport { loadStaticParamsAsync } from '../loadStaticParamsAsync';\n\nconst debug = require('debug')('expo:router:renderStaticContent');\n\nAppRegistry.registerComponent('App', () => ExpoRoot);\n\n/** Get the linking manifest from a Node.js process. */\nasync function getManifest(options: Options = {}) {\n  const routeTree = getRoutes(ctx, {\n    preserveApiRoutes: true,\n    platform: 'web',\n    ...options,\n  });\n\n  if (!routeTree) {\n    throw new Error('No routes found');\n  }\n\n  // Evaluate all static params\n  await loadStaticParamsAsync(routeTree);\n\n  return getReactNavigationConfig(routeTree, false);\n}\n\n/**\n * Get the server manifest with all dynamic routes loaded with `generateStaticParams`.\n * Unlike the `expo-router/src/routes-manifest.ts` method, this requires loading the entire app in-memory, which\n * takes substantially longer and requires Metro bundling.\n *\n * This is used for the production manifest where we pre-render certain pages and should no longer treat them as dynamic.\n */\nasync function getBuildTimeServerManifestAsync(\n  options: Options = {}\n): Promise<ExpoRouterServerManifestV1> {\n  const routeTree = getRoutes(ctx, {\n    platform: 'web',\n    ...options,\n  });\n\n  if (!routeTree) {\n    throw new Error('No routes found');\n  }\n\n  // Evaluate all static params\n  await loadStaticParamsAsync(routeTree);\n\n  return getServerManifest(routeTree);\n}\n\nfunction resetReactNavigationContexts() {\n  // https://github.com/expo/router/discussions/588\n  // https://github.com/react-navigation/react-navigation/blob/9fe34b445fcb86e5666f61e144007d7540f014fa/packages/elements/src/getNamedContext.tsx#LL3C1-L4C1\n\n  // React Navigation is storing providers in a global, this is fine for the first static render\n  // but subsequent static renders of Stack or Tabs will cause React to throw a warning. To prevent this warning, we'll reset the globals before rendering.\n  const contexts = '__react_navigation__elements_contexts';\n  global[contexts] = new Map<string, React.Context<any>>();\n}\n\nexport async function getStaticContent(location: URL): Promise<string> {\n  const headContext: { helmet?: any } = {};\n\n  const ref = React.createRef<ServerContainerRef>();\n\n  const {\n    // NOTE: The `element` that's returned adds two extra Views and\n    // the seemingly unused `RootTagContext.Provider`.\n    element,\n    getStyleElement,\n  } = AppRegistry.getApplication('App', {\n    initialProps: {\n      location,\n      context: ctx,\n      wrapper: ({ children }) => (\n        <Root>\n          <div id=\"root\">{children}</div>\n        </Root>\n      ),\n    },\n  });\n\n  const Root = getRootComponent();\n\n  // Clear any existing static resources from the global scope to attempt to prevent leaking between pages.\n  // This could break if pages are rendered in parallel or if fonts are loaded outside of the React tree\n  Font.resetServerContext();\n\n  // This MUST be run before `ReactDOMServer.renderToString` to prevent\n  // \"Warning: Detected multiple renderers concurrently rendering the same context provider. This is currently unsupported.\"\n  resetReactNavigationContexts();\n\n  const html = await ReactDOMServer.renderToString(\n    <Head.Provider context={headContext}>\n      <ServerContainer ref={ref}>{element}</ServerContainer>\n    </Head.Provider>\n  );\n\n  // Eval the CSS after the HTML is rendered so that the CSS is in the same order\n  const css = ReactDOMServer.renderToStaticMarkup(getStyleElement());\n\n  let output = mixHeadComponentsWithStaticResults(headContext.helmet, html);\n\n  output = output.replace('</head>', `${css}</head>`);\n\n  const fonts = Font.getServerResources();\n  debug(`Pushing static fonts: (count: ${fonts.length})`, fonts);\n  // debug('Push static fonts:', fonts)\n  // Inject static fonts loaded with expo-font\n  output = output.replace('</head>', `${fonts.join('')}</head>`);\n\n  return '<!DOCTYPE html>' + output;\n}\n\nfunction mixHeadComponentsWithStaticResults(helmet: any, html: string) {\n  // Head components\n  for (const key of ['title', 'priority', 'meta', 'link', 'script', 'style'].reverse()) {\n    const result = helmet?.[key]?.toString();\n    if (result) {\n      html = html.replace('<head>', `<head>${result}`);\n    }\n  }\n\n  // attributes\n  html = html.replace('<html ', `<html ${helmet?.htmlAttributes.toString()} `);\n  html = html.replace('<body ', `<body ${helmet?.bodyAttributes.toString()} `);\n\n  return html;\n}\n\n// Re-export for use in server\nexport { getManifest, getBuildTimeServerManifestAsync };\n"],"mappings":"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"}