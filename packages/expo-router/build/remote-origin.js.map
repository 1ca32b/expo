{"version":3,"file":"remote-origin.js","sourceRoot":"","sources":["../src/remote-origin.ts"],"names":[],"mappings":"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","sourcesContent":["import Constants from 'expo-constants';\nimport { useURL } from 'expo-linking';\nimport { useEffect } from 'react';\nimport { Alert } from 'react-native';\nimport getDevServer from 'react-native/Libraries/Core/Devtools/getDevServer';\n\nimport { extractExpoPathFromURL } from './fork/extractPathFromURL';\n\ntype RemoteServer = {\n  getDefault: () => string | null;\n\n  getCurrent: () => string | null;\n\n  prompt: typeof promptChangeServer;\n  /** Reset the remote  */\n  reset: () => void;\n};\n\ndeclare global {\n  /** The client-side controller for the remote server that is used for interacting with SSR. This is useful for testing different servers against production builds. Although, this should never be used in production apps with arbitrary users as it could be leveraged by malicious actors to change the remote server connected to a native client (your app), which has access to sensitive data. */\n  var remote: RemoteServer | undefined;\n}\n\nconst manifest = Constants.expoConfig as Record<string, any> | null;\n\nfunction getCurrentRemoteOrigin(): string | null {\n  return localStorage.getItem('expo_remote_origin') ?? getBaseUrl();\n}\n\n// TODO: This would be better if native and tied as close to the JS engine as possible, i.e. it should\n// reflect the exact location of the JS file that was executed.\nfunction getBaseUrl(): string | null {\n  if (getDevServer().bundleLoadedFromServer) {\n    // if (process.env.NODE_ENV !== 'production') {\n    // e.g. http://localhost:19006\n    return getDevServer().url?.replace(/\\/$/, '');\n  }\n\n  // TODO: Make it official by moving out of `extra`\n  const productionBaseUrl = manifest?.extra?.router?.origin;\n\n  if (!productionBaseUrl) {\n    return null;\n  }\n\n  // Ensure no trailing slash\n  return productionBaseUrl?.replace(/\\/$/, '');\n}\n\nconst remote: RemoteServer = {\n  getDefault: getBaseUrl,\n  getCurrent: getCurrentRemoteOrigin,\n  prompt: promptChangeServer,\n  reset() {\n    localStorage.removeItem('expo_remote_origin');\n    // NOTE: No standard way to restart the app. This will just throw an error that breaks the app lol.\n    globalThis.location.reload();\n  },\n};\n\nexport function promptChangeServer(\n  currentUrl: string | null = getCurrentRemoteOrigin(),\n  placeholder?: string\n) {\n  Alert.prompt(\n    'Change Remote Origin',\n    `Enter a new remote origin (current: ${currentUrl}):`,\n    [\n      {\n        text: 'Cancel',\n        onPress: () => {},\n        style: 'cancel',\n      },\n      {\n        text: 'OK',\n        onPress: (newOrigin) => {\n          if (!newOrigin) {\n            remote.reset();\n            return;\n          }\n          newOrigin = newOrigin.trim();\n\n          if (newOrigin !== currentUrl) {\n            localStorage.setItem('expo_remote_origin', coerceUrl(newOrigin));\n            // NOTE: No standard way to restart the app. This will just throw an error that breaks the app lol.\n            globalThis.location.reload();\n          }\n        },\n      },\n    ],\n    'plain-text',\n    placeholder,\n    'default'\n  );\n}\n\nglobalThis.remote = remote;\n\n// scheme://?__remote_origin=https://bacon.expo.app/\nexport function useRemoteOriginDevTool() {\n  // Enables changing the origin URL for the server. Useful for debugging release apps.\n  // Deep link in with scheme://?__remote_origin=http://localhost:3000 to change the on-device origin. This will persist the value and reset the JS context.\n  // Use `?__remote_origin=` to reset the origin.\n\n  const url = useURL();\n\n  useEffect(() => {\n    if (!url || !url.match(/__remote_origin/)) {\n      return;\n    }\n\n    const normal = extractExpoPathFromURL(url);\n\n    const parsed = new URL(normal, 'http://e');\n    const remoteOrigin = parsed.searchParams.get('__remote_origin');\n\n    console.log('[DEV TOOL]: Remote origin link found:', parsed.toString());\n\n    if (remoteOrigin != null) {\n      if (remoteOrigin) {\n        const possibleUrl = coerceUrl(decodeURIComponent(remoteOrigin));\n        const currentOrigin = getCurrentRemoteOrigin();\n\n        if (currentOrigin === possibleUrl) {\n          alert('The remote origin is already set to the provided value: ' + remoteOrigin);\n          return;\n        }\n\n        promptChangeServer(currentOrigin, remoteOrigin);\n      } else {\n        Alert.prompt(\n          'Change Remote Origin',\n          `Reset the remote origin to the default? (current: ${getCurrentRemoteOrigin()}, default: ${getBaseUrl()})`,\n          [\n            {\n              text: 'Cancel',\n              onPress: () => {},\n              style: 'cancel',\n            },\n            {\n              text: 'OK',\n              onPress: () => {\n                localStorage.removeItem('expo_remote_origin');\n                globalThis.location.reload();\n              },\n            },\n          ]\n        );\n      }\n    }\n  }, [url]);\n}\n\nfunction coerceUrl(urlString: string) {\n  try {\n    let nextUrl = new URL(urlString);\n    // Ensure `http://` or `https://` is present\n    if (!nextUrl.protocol) {\n      nextUrl = new URL('http://' + urlString);\n    }\n    return nextUrl.toString();\n  } catch {\n    console.log('Failed coercing URL:', urlString);\n    return urlString;\n  }\n}\n"]}